name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "claude/**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install AArch64 cross-compilation toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          qemu-system-arm qemu-system-aarch64 make

    - name: Verify toolchain installation
      run: |
        aarch64-linux-gnu-gcc --version
        qemu-system-aarch64 --version
        make --version

    - name: Build firmware
      run: |
        make clean
        make all

    - name: Check build artifacts
      run: |
        ls -lh bin/
        ls -lh obj/
        if [ -f "bin/kernel.elf" ]; then
          echo "✓ kernel.elf built successfully"
          file bin/kernel.elf
          aarch64-linux-gnu-size bin/kernel.elf
        else
          echo "✗ kernel.elf not found!"
          exit 1
        fi

    - name: Run context switch test
      run: |
        echo "Running context switch and timer test..."
        make test-context || true

    - name: Run network init test (user-mode networking)
      run: |
        echo "Running network initialization test..."
        make test-net-init || true

    - name: Setup TAP network for LAN ping test
      run: |
        echo "Setting up TAP network interface for ping test..."
        echo "Host IP: 192.168.1.103, Guest IP: 192.168.1.1"
        sudo ip tuntap add dev qemu-lan mode tap user $USER
        sudo ip addr add 192.168.1.103/24 dev qemu-lan
        sudo ip link set qemu-lan up

        echo "Verifying TAP interface setup..."
        ip addr show qemu-lan
        ip link show qemu-lan

        echo "Testing host can ping itself on TAP interface..."
        ping -c 2 -W 1 192.168.1.103 || echo "Note: Self-ping failed, but TAP is up"

        echo "Checking routing..."
        ip route | grep 192.168.1 || echo "No route to 192.168.1.0/24"

    - name: Run LAN ping test (TAP bridge networking)
      run: |
        echo "Running LAN ping test (Guest 192.168.1.1 -> Host 192.168.1.103)..."
        echo "If this fails, check the TAP network setup above"
        make test-ping-lan || {
          echo "LAN ping test failed - checking network state...";
          ip addr show qemu-lan;
          ip link show qemu-lan;
          exit 1;
        }

    - name: Setup TAP network for WAN ping test
      run: |
        echo "Setting up WAN TAP network interface for ping test..."
        echo "Host IP: 10.3.5.103, Guest IP: 10.3.5.99"
        sudo ip tuntap add dev qemu-wan mode tap user $USER
        sudo ip addr add 10.3.5.103/24 dev qemu-wan
        sudo ip link set qemu-wan up

        echo "Verifying WAN TAP interface setup..."
        ip addr show qemu-wan
        ip link show qemu-wan

        echo "Testing host can ping itself on WAN TAP interface..."
        ping -c 2 -W 1 10.3.5.103 || echo "Note: Self-ping failed, but TAP is up"

        echo "Checking routing..."
        ip route | grep 10.3.5 || echo "No route to 10.3.5.0/24"

    - name: Run WAN ping test (TAP bridge networking)
      run: |
        echo "Running WAN ping test (Guest 10.3.5.99 -> Host 10.3.5.103)..."
        echo "If this fails, check the WAN TAP network setup above"
        make test-ping-wan || {
          echo "WAN ping test failed - checking network state...";
          ip addr show qemu-wan;
          ip link show qemu-wan;
          exit 1;
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: firmware-artifacts
        path: |
          bin/kernel.elf
          os.list
        retention-days: 30

    - name: Upload test binaries
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-binaries
        path: |
          test_bin/*.elf
        retention-days: 7

  # Optional: Additional job for checking code quality
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for large files
      run: |
        echo "Checking for unexpectedly large files..."
        find . -type f -size +10M -not -path "./.git/*" || true

    - name: List source files
      run: |
        echo "Source files:"
        find src/ -type f \( -name "*.c" -o -name "*.h" -o -name "*.S" \) | sort

    - name: Check Makefile syntax
      run: |
        make -n all > /dev/null
        echo "✓ Makefile syntax is valid"
